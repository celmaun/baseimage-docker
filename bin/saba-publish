#!/usr/bin/env bash
# vim:set ft=bash ts=2 sw=2 et :
# shellcheck shell=bash

set -euo pipefail
shopt -s nullglob

# shellcheck source=./.salprojectrc
${SABA__SOURCED- . "$(dirname "$(readlink -e -- "${BASH_SOURCE[0]}")")"/.salprojectrc}

cd "$SABA__ROOT"

set -x

#[salmatron@saltr]$ sed -n '/VERSION\s*?=\s*sal-/{ s/VERSION ?=\s*\(sal-\S\+\)\s*/\1/p; q; }; $q170' ./Makefile; echo $?
#sal-jammy-5.0.0
#0


VERSION="$(sed -n '/VERSION\s*?=\s*sal-/{ s/VERSION ?=\s*\(sal-\S\+\)\s*/\1/p; q; }; $q170' Makefile)"

: "${VERSION:?}"
export VERSION


if [ -n "$(git tag -l "$VERSION")" ]; then
	>&2 printf '%s\n' "Error: Git already has the tag '$VERSION'"
	exit 1
fi


printf '%s\n' "The new VERSION is '$VERSION'"


git tag "$VERSION"


make VERSION="$VERSION" build
make VERSION="$VERSION" tag_latest
make VERSION="$VERSION" release


git push

